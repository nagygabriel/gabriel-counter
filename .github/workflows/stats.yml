name: Process Stats

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Ensure files exist
        run: |
          if [ ! -f counter.json ]; then
            echo "{}" > counter.json
          fi
          if [ ! -f stats.json ]; then
            echo '{"kategorie":{},"fotky":{},"detail":{}}' > stats.json
          fi

      - name: Merge counter.json into stats.json
        run: |
          COUNTER=$(cat counter.json)
          STATS=$(cat stats.json)

          UPDATED=$(echo "$STATS" "$COUNTER" | jq -s '
            .[0] as $stats |
            .[1] as $counter |
            reduce ($counter | keys[]) as $t ($stats;
              .[$t] = (
                reduce ($counter[$t] | keys[]) as $n (.[$t];
                  .[$n] = ((.[$n] // 0) + $counter[$t][$n])
                )
              )
            )
          ')

          echo "$UPDATED" > stats.json
          echo "{}" > counter.json

      - name: Commit and push
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add stats.json counter.json
          git commit -m "Update stats" || echo "No changes"
          git push
